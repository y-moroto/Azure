1. Azure での ID とガバナンスの管理
1.1 Azure Active Directory に Azure のユーザーとグループを作成する
■ユーザとロール
ユーザまたはグループにロールを付与することでアクセスを制御する。
ユーザには以下の種類がある。
・管理者ロール
　ユーザーの作成または編集、他のユーザーへの管理者ロールの割り当て、
　ユーザー パスワードのリセット、ユーザー ライセンスの管理などをユーザーに許可できます。
・メンバーユーザ
　自分のプロファイル情報を管理できる権限など、一連の既定のアクセス許可を付与されたAzure AD 組織のネイティブ メンバーです。
　新しいユーザーが組織に参加したとき、通常はこの種類のアカウントがそのユーザー用に作成されます。
・ゲストユーザ
　制限された Azure AD 組織のアクセス許可が付与されます。
　ユーザーを招待する場合は、そのユーザーをゲスト ユーザーとして Azure AD 組織に追加します。
　次に、受諾リンクを含む招待メールを送信するか、共有するアプリへの直接リンクを送信できます。
　既定では、Azure AD のメンバー ユーザーはゲスト ユーザーを招待できます。（管理者によって無効にすることも可能）
　組織外部のパートナーと協力しなければならない場合に活用。

■ユーザー アカウントの追加
・Azure CLI
az ad user create

・Azure PowerShell
New-AzureADUser

・Azure PowerShellを用いてCSVファイルから一括登録
---------------------------------------
$invitations = import-csv c:\bulkinvite\invitations.csv

$messageInfo = New-Object Microsoft.Open.MSGraph.Model.InvitedUserMessageInfo

$messageInfo.customizedMessageBody = "Hello. You are invited to the Contoso organization."

foreach ($email in $invitations)
   {New-AzureADMSInvitation `
      -InvitedUserEmailAddress $email.InvitedUserEmailAddress `
      -InvitedUserDisplayName $email.Name `
      -InviteRedirectUrl https://myapps.microsoft.com `
      -InvitedUserMessageInfo $messageInfo `
      -SendInvitationMessage $true
   }
---------------------------------------

■ユーザアカウントの削除
ユーザーを削除すると、そのアカウントは 30 日間、中断状態になり、その間であれば復元可能。
・Azure CLI
az ad user delete
・Azure PowerShell
Remove-AzureADUser

■Azure AD 組織を作成する
1. Azure ADの画面内の[作成]をクリック
2. [テナントを作成する]ウィンドウ内で以下の情報を入力
・組織名: Contoso Marketing Company
・初期ドメイン名: contosomarketingXXXXXX（XXXXXXには重複しないように任意の文字列を入力）
3. [作成] を選択
4. 作成が完了するまで待つ
5. [Click here to manage your new tenant](ここをクリックして新しいテナントを管理する) を選択して、新しいテナントに移動

■ユーザを作成する
1. [テナント情報]に表示されている[プライマリ ドメイン名]を控えておく
2. Azure AD 組織の [管理] で、[ユーザー] > [新しいユーザー] を選択
3. [ユーザー] ペインに以下の情報を入力
・ユーザー名: chris@contosomarketingXXXXXX.onmicrosoft.com
・名前: Chris Green
4. [パスワードの表示] を選択してパスワードを控えておく
5. [作成] を選択

■ユーザを削除する
1. Azure AD 組織の [管理] で、[ユーザー]を選択
2. ユーザChris Greenを選択
3. [ユーザーの削除] を選択します。 このオプションが表示されない場合は、[その他] を選択します。
4. [OK] を選択

■削除されたユーザを復元する
1. Azure AD 組織の [管理] で、[ユーザー] > [削除済みのユーザー] を選択
2. これで、過去 30 日以内に削除されたすべてのユーザーが表示されます。
3. Chris Green を選択し、[ユーザーの復元] を選択します。
4. [OK] を選択して確認します。
5. Chris Green のアカウントが復元されたことを確かめるために、[すべてのユーザー] を選択します。

■Azure AD でのアクセス管理
・


1.2 Azure Active Directory のユーザーとグループの管理
■ディレクトリ、サブスクリプション、およびユーザー
AzureまたはM365などのサービスを利用すると、既定の "ディレクトリ"、つまり Azure AD のインスタンスが割り当てられる。
テナントは、組織と、それに割り当てられた既定のディレクトリを表す。
サブスクリプションは課金エンティティおよびセキュリティの境界である。
仮想マシン、Web サイト、データベースなどのリソースは、単一サブスクリプションに関連付けられ、
サブスクリプションは、単一のAzure AD ディレクトリに関連付けられます。
ADディレクトリは複数のサブスクリプションを持つことができるが、
サブスクリプションから見れば、紐づくADディレクトリはひとつだけ。
サブスクリプションは他のADディレクトリに譲渡することができる。
ユーザとグループは複数のサブスクリプションに追加できる。
サブスクリプションにユーザを追加するときは、
そのサブスクリプションに信頼されているADディレクトリにユーザが登録されていなければならない。
複数のディレクトリに属している場合は、
Azure portal ヘッダーの [Directory + subscription](ディレクトリ + サブスクリプション) ボタンを使用して、
（Cloud Shellアイコンの右隣にある、ノートと漏斗型のアイコン）
作業中の現在のディレクトリを切り替えることができる。

通常、Azure AD は次の 3 つの方法でユーザーを定義します。

クラウド ID - これらのユーザーは Azure AD にのみ存在します。 
例として、自分で管理する管理者アカウントとユーザーがあります。 
別の Azure AD インスタンスで定義されているユーザーが、
このディレクトリによって制御されるサブスクリプション リソースにアクセスする必要がある場合、
そのソースは Azure Active Directory または External Azure Active Directory です。 
これらのアカウントは、プライマリ ディレクトリからなくなると、削除されます。

ディレクトリ同期 ID - これらのユーザーはオンプレミスの Active Directory に存在します。 
Azure AD Connect を介して実行される同期アクティビティにより、これらのユーザーは Azure に提供されます。 そのソースは、Windows Server AD です。

Guest ユーザー - これらのユーザーは Azure の外部に存在します。 
例として、他のクラウド プロバイダーのアカウント、Xbox LIVE アカウントなどの Microsoft アカウントがあります。
そのソースは、招待されたユーザー です。 この種類のアカウントは、外部ベンダーや請負業者が Azure リソースへのアクセスを必要とする場合に便利です。
ヘルプが不要になったら、アカウントとすべてのアクセス権を削除できます。

■ユーザを追加する
Azure AD にクラウド ID を追加するには、複数の方法があります。

・オンプレミスの Windows Server Active Directory を同期する
⇒Azure AD Connectを用いてオンプレからAzureへ同期する
・Azure ポータルの使用
⇒実際に使って試すこと。
・コマンド ラインの使用
⇒上記参照
・その他のオプション
Azure AD Graph API を使用する、または同じディレクトリを共有している場合は Microsoft 365 管理センターと
Microsoft Intune 管理コンソールを使用して、Azure AD にユーザーを追加することもできます。


■グループの作成と管理
Azure AD では、2 つの異なる種類のグループを定義できます。

1. セキュリティ グループ
最も一般的で、ユーザー グループの共有リソースへのメンバーとコンピューターのアクセスを管理するために使用されます。
たとえば、特定のセキュリティ ポリシーのセキュリティ グループを作成できます。 このようにすると、すべてのメンバーにアクセス許可のセットを一度に付与でき、
各メンバーにアクセス許可を個別に追加する必要がありません。 このオプションを使用するには、Azure AD 管理者が必要です。

2. Microsoft 365 グループ
このグループは、共有メールボックス、カレンダー、ファイル、SharePoint サイトなどへのアクセス権をメンバーに付与して、共同作業の機会を提供します。
このオプションを使用すると、組織外のユーザーにグループへのアクセス権を付与することもできます。 このオプションは、ユーザーおよび管理者が使用できます。

メンバーシップの種類
1. 割り当て済み
手動で特定のユーザまたはグループに割り当てられたグループ。（グループは入れ子も可能）
2. 動的ユーザ
ルールに基づいて、ユーザの属性によって所属グループが自動割当される。
例えばユーザの所属部署が販売だった場合は、自動的に販売グループに割り当てられる。
そして所属部署が変更されると、自動的に所属グループも変更される。
3. 動的デバイス
ルールに基づいて、デバイスの属性によって所属グループが自動割当される。
例えば、ユーザーのデバイスがサービス部門に関連付けられている場合、そのデバイスはサービス グループに動的に割り当てられる。
デバイスと特定の部門との関連付けが今後変更された場合、自動的に所属グループから削除される。

グループ所有者：当該グループを管理できる個々のユーザまたは他のグループ（複数選択可）

Azure PowerShellで追加する場合は、New-AzureADGroup コマンドを使用する。

■ロールを使用したリソース アクセスの制御
主な組み込みロールは以下の通り。
所有者：他のユーザーにアクセス許可を委任する権限を含め、すべてのリソースへのフル アクセス権を持ちます。
共同作成者：Azure リソースのすべてのタイプを作成および管理できますが、他のユーザーにアクセス許可を付与することはできません。
閲覧者：既存の Azure リソースを表示できます。

■ロールの定義
JavaScript Object Notation (JSON) ファイルに定義されるプロパティのセットです。
ロールの定義には、名前、ID、説明、許可される権限 (Actions)、拒否される権限 (NotActions)、
およびロールのスコープ (読み取りアクセスなど) が含まれます。
所有者ロールには、すべてのアクションを意味するアスタリスク (*) が示され、拒否されるアクションはありません。
すべてのスコープであるスラッシュ (/) が示されます。
この情報は、PowerShell の Get-AzRoleDefinition コマンドレットを使用して取得できます。

■組み込みロールを確認する
リソースグループのロールタブで確認

■ロールの定義
名前	説明
Id	Azure によって割り当てられた、ロールの一意識別子。
IsCustom	カスタム ロールの場合は True、組み込みロールの場合は False です。
Description	ロールの理解しやすい説明。
Actions []	許可されるアクセス許可。* はすべてを示します。
NotActions []	拒否されるアクセス許可。
DataActions []	特定の許可されるアクセス許可で、データに適用されます (たとえば、Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read)
NotDataActions []	特定の拒否されるアクセス許可で、データに適用されます。
AssignableScopes []	このロールが適用されるスコープ。 / はグローバルを示しますが、階層構造にすることができます。

■Actions と NotActions
Actions プロパティと NotActions プロパティを調整して、必要なアクセス許可を付与および拒否することができます。 これらのプロパティは常に {Company}.{ProviderName}/{resourceType}/{action} の形式になります。

例として、先ほど確認した 3 つのロールのアクションを次に示します。

■ACTIONS と NOTACTIONS
組み込みロール	Actions	NotActions
所有者 (すべてのアクションを許可)	*	-
共同作成者 (ロールの割り当ての書き込みまたは削除を除くすべての操作を許可)	*	Microsoft.Authorization/*/Delete, Microsoft.Authorization/*/Write, Microsoft.Authorization/*/elevateAccess/Action
閲覧者 (すべての読み取り操作を許可)	*/read	-



