1. Azure での ID とガバナンスの管理
1.1 Azure Active Directory に Azure のユーザーとグループを作成する
■ユーザとロール
ユーザまたはグループにロールを付与することでアクセスを制御する。
ユーザには以下の種類がある。
・管理者ロール
　ユーザーの作成または編集、他のユーザーへの管理者ロールの割り当て、
　ユーザー パスワードのリセット、ユーザー ライセンスの管理などをユーザーに許可できます。
・メンバーユーザ
　自分のプロファイル情報を管理できる権限など、一連の既定のアクセス許可を付与されたAzure AD 組織のネイティブ メンバーです。
　新しいユーザーが組織に参加したとき、通常はこの種類のアカウントがそのユーザー用に作成されます。
・ゲストユーザ
　制限された Azure AD 組織のアクセス許可が付与されます。
　ユーザーを招待する場合は、そのユーザーをゲスト ユーザーとして Azure AD 組織に追加します。
　次に、受諾リンクを含む招待メールを送信するか、共有するアプリへの直接リンクを送信できます。
　既定では、Azure AD のメンバー ユーザーはゲスト ユーザーを招待できます。（管理者によって無効にすることも可能）
　組織外部のパートナーと協力しなければならない場合に活用。

■ユーザー アカウントの追加
・Azure CLI
az ad user create

・Azure PowerShell
New-AzureADUser

・Azure PowerShellを用いてCSVファイルから一括登録
---------------------------------------
$invitations = import-csv c:\bulkinvite\invitations.csv

$messageInfo = New-Object Microsoft.Open.MSGraph.Model.InvitedUserMessageInfo

$messageInfo.customizedMessageBody = "Hello. You are invited to the Contoso organization."

foreach ($email in $invitations)
   {New-AzureADMSInvitation `
      -InvitedUserEmailAddress $email.InvitedUserEmailAddress `
      -InvitedUserDisplayName $email.Name `
      -InviteRedirectUrl https://myapps.microsoft.com `
      -InvitedUserMessageInfo $messageInfo `
      -SendInvitationMessage $true
   }
---------------------------------------

■ユーザアカウントの削除
ユーザーを削除すると、そのアカウントは 30 日間、中断状態になり、その間であれば復元可能。
・Azure CLI
az ad user delete
・Azure PowerShell
Remove-AzureADUser

■Azure AD 組織を作成する
1. Azure ADの画面内の[作成]をクリック
2. [テナントを作成する]ウィンドウ内で以下の情報を入力
・組織名: Contoso Marketing Company
・初期ドメイン名: contosomarketingXXXXXX（XXXXXXには重複しないように任意の文字列を入力）
3. [作成] を選択
4. 作成が完了するまで待つ
5. [Click here to manage your new tenant](ここをクリックして新しいテナントを管理する) を選択して、新しいテナントに移動

■ユーザを作成する
1. [テナント情報]に表示されている[プライマリ ドメイン名]を控えておく
2. Azure AD 組織の [管理] で、[ユーザー] > [新しいユーザー] を選択
3. [ユーザー] ペインに以下の情報を入力
・ユーザー名: chris@contosomarketingXXXXXX.onmicrosoft.com
・名前: Chris Green
4. [パスワードの表示] を選択してパスワードを控えておく
5. [作成] を選択

■ユーザを削除する
1. Azure AD 組織の [管理] で、[ユーザー]を選択
2. ユーザChris Greenを選択
3. [ユーザーの削除] を選択します。 このオプションが表示されない場合は、[その他] を選択します。
4. [OK] を選択

■削除されたユーザを復元する
1. Azure AD 組織の [管理] で、[ユーザー] > [削除済みのユーザー] を選択
2. これで、過去 30 日以内に削除されたすべてのユーザーが表示されます。
3. Chris Green を選択し、[ユーザーの復元] を選択します。
4. [OK] を選択して確認します。
5. Chris Green のアカウントが復元されたことを確かめるために、[すべてのユーザー] を選択します。

■Azure AD でのアクセス管理
・


1.2 Azure Active Directory のユーザーとグループの管理
■ディレクトリ、サブスクリプション、およびユーザー
AzureまたはM365などのサービスを利用すると、既定の "ディレクトリ"、つまり Azure AD のインスタンスが割り当てられる。
テナントは、組織と、それに割り当てられた既定のディレクトリを表す。
サブスクリプションは課金エンティティおよびセキュリティの境界である。
仮想マシン、Web サイト、データベースなどのリソースは、単一サブスクリプションに関連付けられ、
サブスクリプションは、単一のAzure AD ディレクトリに関連付けられます。
ADディレクトリは複数のサブスクリプションを持つことができるが、
サブスクリプションから見れば、紐づくADディレクトリはひとつだけ。
サブスクリプションは他のADディレクトリに譲渡することができる。
ユーザとグループは複数のサブスクリプションに追加できる。
サブスクリプションにユーザを追加するときは、
そのサブスクリプションに信頼されているADディレクトリにユーザが登録されていなければならない。
複数のディレクトリに属している場合は、
Azure portal ヘッダーの [Directory + subscription](ディレクトリ + サブスクリプション) ボタンを使用して、
（Cloud Shellアイコンの右隣にある、ノートと漏斗型のアイコン）
作業中の現在のディレクトリを切り替えることができる。

通常、Azure AD は次の 3 つの方法でユーザーを定義します。

クラウド ID - これらのユーザーは Azure AD にのみ存在します。 
例として、自分で管理する管理者アカウントとユーザーがあります。 
別の Azure AD インスタンスで定義されているユーザーが、
このディレクトリによって制御されるサブスクリプション リソースにアクセスする必要がある場合、
そのソースは Azure Active Directory または External Azure Active Directory です。 
これらのアカウントは、プライマリ ディレクトリからなくなると、削除されます。

ディレクトリ同期 ID - これらのユーザーはオンプレミスの Active Directory に存在します。 
Azure AD Connect を介して実行される同期アクティビティにより、これらのユーザーは Azure に提供されます。 そのソースは、Windows Server AD です。

Guest ユーザー - これらのユーザーは Azure の外部に存在します。 
例として、他のクラウド プロバイダーのアカウント、Xbox LIVE アカウントなどの Microsoft アカウントがあります。
そのソースは、招待されたユーザー です。 この種類のアカウントは、外部ベンダーや請負業者が Azure リソースへのアクセスを必要とする場合に便利です。
ヘルプが不要になったら、アカウントとすべてのアクセス権を削除できます。

■ユーザを追加する
Azure AD にクラウド ID を追加するには、複数の方法があります。

・オンプレミスの Windows Server Active Directory を同期する
⇒Azure AD Connectを用いてオンプレからAzureへ同期する
・Azure ポータルの使用
⇒実際に使って試すこと。
・コマンド ラインの使用
⇒上記参照
・その他のオプション
Azure AD Graph API を使用する、または同じディレクトリを共有している場合は Microsoft 365 管理センターと
Microsoft Intune 管理コンソールを使用して、Azure AD にユーザーを追加することもできます。


■グループの作成と管理
Azure AD では、2 つの異なる種類のグループを定義できます。

1. セキュリティ グループ
最も一般的で、ユーザー グループの共有リソースへのメンバーとコンピューターのアクセスを管理するために使用されます。
たとえば、特定のセキュリティ ポリシーのセキュリティ グループを作成できます。 このようにすると、すべてのメンバーにアクセス許可のセットを一度に付与でき、
各メンバーにアクセス許可を個別に追加する必要がありません。 このオプションを使用するには、Azure AD 管理者が必要です。

2. Microsoft 365 グループ
このグループは、共有メールボックス、カレンダー、ファイル、SharePoint サイトなどへのアクセス権をメンバーに付与して、共同作業の機会を提供します。
このオプションを使用すると、組織外のユーザーにグループへのアクセス権を付与することもできます。 このオプションは、ユーザーおよび管理者が使用できます。

メンバーシップの種類
1. 割り当て済み
手動で特定のユーザまたはグループに割り当てられたグループ。（グループは入れ子も可能）
2. 動的ユーザ
ルールに基づいて、ユーザの属性によって所属グループが自動割当される。
例えばユーザの所属部署が販売だった場合は、自動的に販売グループに割り当てられる。
そして所属部署が変更されると、自動的に所属グループも変更される。
3. 動的デバイス
ルールに基づいて、デバイスの属性によって所属グループが自動割当される。
例えば、ユーザーのデバイスがサービス部門に関連付けられている場合、そのデバイスはサービス グループに動的に割り当てられる。
デバイスと特定の部門との関連付けが今後変更された場合、自動的に所属グループから削除される。

グループ所有者：当該グループを管理できる個々のユーザまたは他のグループ（複数選択可）

Azure PowerShellで追加する場合は、New-AzureADGroup コマンドを使用する。

■ロールを使用したリソース アクセスの制御
主な組み込みロールは以下の通り。
所有者：他のユーザーにアクセス許可を委任する権限を含め、すべてのリソースへのフル アクセス権を持ちます。
共同作成者：Azure リソースのすべてのタイプを作成および管理できますが、他のユーザーにアクセス許可を付与することはできません。
閲覧者：既存の Azure リソースを表示できます。

■ロールの定義
JavaScript Object Notation (JSON) ファイルに定義されるプロパティのセットです。
ロールの定義には、名前、ID、説明、許可される権限 (Actions)、拒否される権限 (NotActions)、
およびロールのスコープ (読み取りアクセスなど) が含まれます。
所有者ロールには、すべてのアクションを意味するアスタリスク (*) が示され、拒否されるアクションはありません。
すべてのスコープであるスラッシュ (/) が示されます。
この情報は、PowerShell の Get-AzRoleDefinition コマンドレットを使用して取得できます。

■組み込みロールを確認する
リソースグループのロールタブで確認

■ロールの定義
名前	説明
Id	Azure によって割り当てられた、ロールの一意識別子。
IsCustom	カスタム ロールの場合は True、組み込みロールの場合は False です。
Description	ロールの理解しやすい説明。
Actions []	許可されるアクセス許可。* はすべてを示します。
NotActions []	拒否されるアクセス許可。
DataActions []	特定の許可されるアクセス許可で、データに適用されます (たとえば、Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read)
NotDataActions []	特定の拒否されるアクセス許可で、データに適用されます。
AssignableScopes []	このロールが適用されるスコープ。 / はグローバルを示しますが、階層構造にすることができます。

■Actions と NotActions
Actions プロパティと NotActions プロパティを調整して、必要なアクセス許可を付与および拒否することができます。 これらのプロパティは常に {Company}.{ProviderName}/{resourceType}/{action} の形式になります。

例として、先ほど確認した 3 つのロールのアクションを次に示します。

■ACTIONS と NOTACTIONS
組み込みロール	Actions	NotActions
所有者 (すべてのアクションを許可)	*	-
共同作成者 (ロールの割り当ての書き込みまたは削除を除くすべての操作を許可)	*	Microsoft.Authorization/*/Delete, Microsoft.Authorization/*/Write, Microsoft.Authorization/*/elevateAccess/Action
閲覧者 (すべての読み取り操作を許可)	*/read	-

Actionsで許可された操作内容から、NotActionsの分が除かれて、最終的な許可内容が定義される。

■DataActions と NotDataActions
DataActions プロパティと NotDataActions プロパティに追加できるのはデータ操作のみです。
リソース プロバイダーでは、isDataAction プロパティを true に設定して、どの操作がデータ操作であるかを指定します。
データ操作のないロールでは、ロールの定義からこれらのプロパティを省略できます。
許可するアクション (すべての場合は *) を指定し、NotDataActions コレクション内で削除する特定のアクションの一覧を指定します。

データ操作	説明
Microsoft.Storage/storageAccounts/blobServices/containers/blobs/delete	BLOB データを削除する
Microsoft.Compute/virtualMachines/login/action	通常のユーザーとして VM にログインする
Microsoft.EventHub/namespaces/messages/send/action	イベント ハブでメッセージを送信する
Microsoft.Storage/storageAccounts/fileServices/fileshares/files/read	ファイル/フォルダーまたはファイル/フォルダーの一覧を返す
Microsoft.Storage/storageAccounts/queueServices/queues/messages/read	キューからメッセージを読み取る

■割り当て可能なスコープ
ロールの AssignableScopes プロパティで、ロールが割り当てに使用できるスコープ (サブスクリプション、リソース グループ、またはリソース) を指定します。

目的	スコープの使用
サブスクリプションに制限する。	"/subscriptions/{sub-id}"
特定のサブスクリプションで特定のリソース グループに制限する。	"/subscriptions/{sub-id}/resourceGroups/{rg-name}"
特定のリソースに制限する。	"/subscriptions/{sub-id}/resourceGroups/{rg-name}/{resource-name}"
2 つのサブスクリプションの割り当てにロールを使用可能にする。	"/subscriptions/{sub-id}", "/subscriptions/{sub-id}"

■ロールを作成する
基本的には組み込みロールを使用することが推奨されるが、どうしてもカスタムロールが必要な場合は、以下の方法で作成する。
Azure Portal：Azure portal を使用して、[Azure Active Directory] > [ロールと管理者] > [新しいカスタム ロール] を選択して、カスタム ロールを作成できます。
Azure PowerShell：New-AzADMSRoleDefinition コマンドレットを使用して、新しいロールを定義できます。
Azure AD Graph API：プログラムで Graph API の REST 呼び出しを使用して、新しいロールを作成できます。
カスタム ロールの作成には Azure AD Premium P1 または P2 が必要。

■Azure AD Connect を使用して Active Directory を Azure AD に接続する
Azure AD Connectに含まれるコンポーネント
・同期サービス
このコンポーネントは、ユーザー、グループ、およびその他のオブジェクトを作成する役割を果たします。
また、オンプレミスのユーザーとグループの ID 情報をクラウド側と一致させます。
・正常性の監視
Azure AD Connect Health では堅牢な監視機能が提供され、Azure portal の中央の場所でこのアクティビティを確認することができます。
・AD FS
フェデレーションは Azure AD Connect のオプション コンポーネントです。これを使用して、オンプレミスの AD FS インフラストラクチャからハイブリッド環境を構成できます。
組織はこれを使用して、ドメイン参加による SSO、Active Directory サインイン ポリシーの適用、スマート カードやサード パーティの多要素認証など、複雑なデプロイに対応できます。
・パスワード ハッシュの同期
この機能は、ユーザーのオンプレミス Active Directory パスワードのハッシュを Azure AD と同期させるサインイン方法です。
・パススルー認証
ユーザーは、オンプレミスのアプリケーションとクラウド ベースのアプリケーションの両方に同じパスワードを使用してサインインできます。
ユーザーがサインイン方法を忘れる可能性が低くなるため、IT ヘルプデスクのコストが削減されます。
この機能は、パスワード ハッシュの同期 の代わりに使用でき、組織のセキュリティとパスワードの複雑なポリシーを強制することができます。

メリット：
ユーザーは、単一の ID を使ってオンプレミスのアプリケーションとクラウド サービス (Microsoft 365 など) の両方にアクセスできます。
単一のツールにより、同期とサインインのための容易なデプロイを実現できます。
統合により、シナリオに適した最新の機能が手に入ります

インストール：
Azure AD Connect のインストールと構成作業は簡単ではなく、開始する前に初期計画と決定が必要になります。
Microsoft には、AD Connect のセットアップを準備、インストール、構成、およびテストを支援する完全インストール ガイドが用意されています。

■Azure Active Directory のセルフサービス パスワード リセット を使用して、ユーザーがパスワードをリセットできるようにする
・SSPR のしくみ
ユーザーは、パスワード リセット ポータルに直接移動するか、サインイン ページの [アカウントにアクセスできない場合] リンクをクリックすることにより、
パスワードのリセットを始めます。 リセット ポータルでのステップは次のとおりです。

ローカライズ: ポータルでブラウザーのロケール設定が確認されて、適切な言語で SSPR ページが表示されます。
確認: ユーザーは、ユーザー名を入力し、CAPTCHA を渡して、自分がボットではなくユーザーであることを証明します。
認証: ユーザーは、ID の認証に必要なデータを入力します。 たとえば、コードを入力したり、セキュリティの質問に回答したりします。
パスワードのリセット: ユーザーは、認証テストに合格すると、新しいパスワードを入力して確認することができます。
通知: 通常、リセットを確認するメッセージがユーザーに送信されます。

SSPR のユーザー エクスペリエンスをカスタマイズするには、いくつかの方法があります。
たとえば、サインイン ページに会社のロゴを追加し、ユーザーがパスワードをリセットするための適切な場所にいることを、ユーザーに知らせることができます。

■パスワード リセットの認証を行う
パスワードのリセットを許可する前に、ユーザーの ID を確認することが重要です。
悪意のあるユーザーが、システムの弱点を悪用して、そのユーザーを偽装する可能性があります。
Azure では、リセット要求を認証するために 6 つの異なる方法がサポートされています。
管理者は、SSPR を構成するときに使用する方法を選択します。
ユーザーが簡単に使用できる方法を自分で選択できるよう、これらの方法のうち 2 つ以上を有効にしてください。
認証方法	登録方法	パスワード リセットの認証方法
モバイル アプリの通知	モバイル デバイスに Microsoft Authenticator アプリをインストールした後、多要素認証のセットアップ ページで登録します。	Azure からアプリに通知が送信されます。この通知は、確認または拒否することができます。
モバイル アプリ コード	この方法でも Authenticator アプリが使用され、同じ方法でインストールして登録します。	アプリからコードを入力します。
電子メール	Azure と Microsoft 365 の外部にあるメール アドレスを指定します。	Azure によってアドレスにコードが送信されるので、それをリセット ウィザードで入力します。
携帯電話	携帯電話番号を指定します。	Azure によって SMS メッセージで携帯電話にコードが送信されるので、それをリセット ウィザードで入力します。 または、自動呼び出しを受け取るように選択することもできます。
会社電話	携帯以外の電話番号を指定します。	この番号で自動呼び出しを受け取り、# キーを押します。
セキュリティの質問	"母親が生まれた市区町村" のような質問を選択し、 それに対する応答を保存します。	質問に回答します。

無料および試用版の Azure AD 組織では、電話呼び出しのオプションはサポートされていません。

■認証方法の最小数を要求する
ユーザーが設定する必要のある方法の最小数 (1 または 2) を指定できます。
セキュリティの質問の方法については、この方法で登録するためにユーザーが設定する必要がある質問の最小数を指定できます。 
また、パスワードをリセットするために適切に回答する必要がある質問の最小数を指定することもできます。

■推奨設定
・2 つ以上の認証リセット要求方法を有効にします。
・主要な方法としてはモバイル アプリの通知またはコードを使用しますが、モバイル デバイスを持たないユーザーに対応するため、メールまたは会社電話による方法も有効にします。
・携帯電話による方法は、不正な SMS メッセージを送信できるため、推奨されません。
・セキュリティの質問のオプションは、セキュリティの質問に対する回答を他の人に知られる可能性があるため、最も推奨されない方法です。
　セキュリティの質問の方法は、少なくとも 1 つの他の方法と組み合わせた場合のみ使用してください。

■管理者ロールに関連付けられているアカウント
・管理者ロールを持つアカウントには、他のユーザーに対する構成に関係なく、常に、強力な 2 つの方法の認証ポリシーが適用されます。
・管理者ロールに関連付けられているアカウントに対しては、セキュリティの質問の方法は使用できません。

■通知を構成する
管理者は、パスワードの変更をユーザーに通知する方法を選択できます。 有効にできるオプションは次の 2 つです。
・パスワードのリセットについてユーザーに通知しますか？: 
　自分のパスワードをリセットしたユーザーには、プライマリおよびセカンダリの電子メール アドレスに通知されます。
　悪意のあるユーザーによってリセットが行われた場合、この通知はユーザーに対するアラートになり、軽減手順を実行でます。
・他の管理者が自分のパスワードをリセットしたときに、すべての管理者に通知しますか？:
　管理者が自分のパスワードをリセットすると、他のすべての管理者が通知を受け取ります。

■ライセンスの要件
・サインインしているすべてのユーザーは、Azure AD のエディションに関係なく、自分のパスワードを変更できます。
・サインインしていないときに、パスワードを忘れた場合、またはパスワードの有効期限が切れた場合、Azure AD Premium P1 または P2 では SSPR を使用できます。
　また、Microsoft 365 Apps for business または Microsoft 365 でも使用できます。
・オンプレミスの Active Directory とクラウドの Azure AD の両方を使用しているハイブリッド環境では、
　クラウドでのパスワードの変更を、オンプレミスのディレクトリに書き戻す必要があります。
　この書き戻しのサポートは、Azure AD Premium の P1 または P2 で使用できます。 Microsoft 365 Apps for business でも使用できます。

■前提条件
SSPR の構成を始める前に、次のものを用意する必要があります。

Azure AD 組織：この組織では、少なくとも試用版ライセンスを有効にする必要があります。
グローバル管理者特権を持つ Azure AD アカウント：このアカウントを使用して、SSPR を設定します。
管理者以外のユーザー アカウント：このアカウントを使用して、SSPR をテストします。このユーザーおよびすべてのユーザー アカウントは、SSPR を使用するための有効なライセンスを持っている必要があります。
構成をテストするセキュリティ グループ：管理者以外のユーザー アカウントは、このグループのメンバーである必要があります。 このセキュリティ グループを使用して、SSPR をロールアウトするユーザーを制限します。

■SSPR のロールアウトの範囲
無効: Azure AD 組織内のすべてのユーザーが SSPR を使用できません。 これが既定値です。
有効: Azure AD 組織内のすべてのユーザーが SSPR を使用できます。
選択: 指定したセキュリティ グループのメンバーだけが、SSPR を使用できます。まずはこのオプションでテストしてから有効に切り替える。




